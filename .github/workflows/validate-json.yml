name: Validate BcNuGetFeeds.json

on:
  pull_request:
    branches:
      - main
    paths:
      - 'BcNuGetFeeds.json'

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON syntax and structure
        shell: pwsh
        run: |
          Write-Host "Validating JSON syntax..."
          try {
            $json = Get-Content BcNuGetFeeds.json -Raw | ConvertFrom-Json
          }
          catch {
            Write-Host "❌ Invalid JSON syntax: $_" -ForegroundColor Red
            exit 1
          }
          Write-Host "✅ JSON syntax is valid" -ForegroundColor Green
          
          $errors = @()
          $requiredFields = @('owner', 'public', 'description', 'contact', 'viewfeed', 'url')
          
          if ($json -isnot [System.Array]) {
            Write-Host "❌ BcNuGetFeeds.json must be an array" -ForegroundColor Red
            exit 1
          }
          
          foreach ($entry in $json) {
            $entryName = if ($entry.owner) { $entry.owner } else { "Unknown entry" }
            
            foreach ($field in $requiredFields) {
              if (-not $entry.PSObject.Properties[$field]) {
                $errors += "Entry '$entryName': Missing required field '$field'"
              }
            }
            
            # Validate field types
            if ($null -ne $entry.public -and $entry.public -isnot [bool]) {
              $errors += "Entry '$entryName': Field 'public' must be a boolean"
            }
            
            # Validate URL format
            if ($entry.url -and $entry.url -notmatch '^https?://') {
              $errors += "Entry '$entryName': Field 'url' must be a valid HTTP(S) URL"
            }
            
            if ($entry.viewfeed -and $entry.viewfeed -notmatch '^https?://') {
              $errors += "Entry '$entryName': Field 'viewfeed' must be a valid HTTP(S) URL"
            }
            
            # Validate email format
            if ($entry.contact -and $entry.contact -notmatch '@') {
              $errors += "Entry '$entryName': Field 'contact' must be a valid email address"
            }
            
            # Validate patterns array
            if ($entry.PSObject.Properties['patterns']) {
              if ($entry.patterns -isnot [System.Array]) {
                $errors += "Entry '$entryName': Field 'patterns' must be an array"
              }
              else {
                foreach ($pattern in $entry.patterns) {
                  if ($pattern -isnot [string]) {
                    $errors += "Entry '$entryName': Field 'patterns' contains a non-string value"
                  }
                }
              }
            }
            
            # Validate fingerprints array
            if ($entry.PSObject.Properties['fingerprints']) {
              if ($entry.fingerprints -isnot [System.Array]) {
                $errors += "Entry '$entryName': Field 'fingerprints' must be an array"
              }
              else {
                foreach ($fingerprint in $entry.fingerprints) {
                  if ($fingerprint -isnot [string]) {
                    $errors += "Entry '$entryName': Field 'fingerprints' contains a non-string value"
                  }
                }
              }
            }
          }
          
          if ($errors.Count -gt 0) {
            Write-Host "❌ Validation failed with $($errors.Count) error(s):" -ForegroundColor Red
            foreach ($error in $errors) {
              Write-Host "  - $error" -ForegroundColor Red
            }
            exit 1
          }
          
          Write-Host "✅ All $($json.Count) entries are valid" -ForegroundColor Green
